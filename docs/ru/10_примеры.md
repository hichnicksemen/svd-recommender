# Примеры использования

В этой главе представлены полные end-to-end примеры использования библиотеки для типичных задач.

## Пример 1: Implicit Feedback система (MovieLens + EASE)

Самый простой и быстрый способ создать рекомендательную систему.

```python
# ==================== ПОЛНЫЙ ПРИМЕР ====================
from recommender import (
    EASERecommender,
    load_movielens,
    InteractionDataset,
    Evaluator
)
import time

print("=" * 60)
print("ПРИМЕР 1: Implicit Feedback с EASE")
print("=" * 60)

# 1. Загрузка данных
print("\n1. Загрузка MovieLens-1M...")
df = load_movielens(size='1m')
print(f"   Загружено {len(df):,} взаимодействий")
print(f"   Пользователей: {df['user_id'].nunique():,}")
print(f"   Items: {df['item_id'].nunique():,}")

# 2. Подготовка датасета
print("\n2. Подготовка датасета...")
dataset = InteractionDataset(
    df,
    implicit=True,  # Бинаризовать для implicit
    min_user_interactions=5
)

# 3. Разделение данных
print("\n3. Разделение на train/test...")
train, test = dataset.split(
    test_size=0.2,
    strategy='random',
    seed=42
)
print(f"   Train: {len(train.data):,} взаимодействий")
print(f"   Test: {len(test.data):,} взаимодействий")

# 4. Обучение EASE
print("\n4. Обучение EASE...")
model = EASERecommender(l2_reg=500.0)

start_time = time.time()
model.fit(train.data)
training_time = time.time() - start_time

print(f"   ✅ Обучение завершено за {training_time:.2f} секунд!")

# 5. Генерация рекомендаций
print("\n5. Генерация рекомендаций...")
sample_users = [1, 2, 3]
recommendations = model.recommend(sample_users, k=10, exclude_seen=True)

for user_id in sample_users:
    items = recommendations[user_id]
    print(f"\n   User {user_id}:")
    for item_id, score in items[:5]:
        print(f"      Item {item_id}: score = {score:.3f}")

# 6. Оценка качества
print("\n6. Оценка качества...")
evaluator = Evaluator(
    metrics=['precision', 'recall', 'ndcg', 'hit_rate'],
    k_values=[5, 10, 20]
)

results = evaluator.evaluate(
    model,
    test_data=test,
    task='ranking',
    exclude_train=True,
    train_data=train
)

print("\n   Результаты:")
evaluator.print_results(results)

# 7. Сохранение модели
print("\n7. Сохранение модели...")
model.save('models/ease_movielens_1m.pkl')
print("   ✅ Модель сохранена в models/ease_movielens_1m.pkl")

print("\n" + "=" * 60)
print("✅ ПРИМЕР 1 ЗАВЕРШЁН")
print("=" * 60)
```

## Пример 2: Explicit Ratings (MovieLens + SVD++)

Предсказание рейтингов с учётом implicit feedback.

```python
# ==================== ПОЛНЫЙ ПРИМЕР ====================
from recommender import (
    SVDPlusPlusRecommender,
    load_movielens,
    InteractionDataset,
    Evaluator
)

print("=" * 60)
print("ПРИМЕР 2: Explicit Ratings с SVD++")
print("=" * 60)

# 1. Загрузка (оставляем explicit ratings)
print("\n1. Загрузка MovieLens-100K...")
df = load_movielens(size='100k')
print(f"   Рейтинги от {df['rating'].min():.1f} до {df['rating'].max():.1f}")

# 2. Подготовка (НЕ бинаризуем!)
print("\n2. Подготовка explicit feedback...")
dataset = InteractionDataset(
    df,
    implicit=False,  # Важно: explicit
    min_user_interactions=10
)

# 3. Разделение
train, test = dataset.split(test_size=0.2, strategy='random', seed=42)

# 4. Обучение SVD++
print("\n4. Обучение SVD++...")
model = SVDPlusPlusRecommender(
    n_factors=20,
    n_epochs=20,
    lr=0.005,
    reg=0.02,
    random_state=42
)

model.fit(train.data)
print("   ✅ Обучение завершено!")

# 5. Предсказание рейтингов
print("\n5. Предсказание рейтингов...")
sample_pairs = [
    (1, 10), (1, 50), (2, 100), (2, 200)
]

for user_id, item_id in sample_pairs:
    predicted_rating = model.predict([user_id], [item_id])[0]
    print(f"   User {user_id}, Item {item_id}: "
          f"предсказано {predicted_rating:.2f}")

# 6. Оценка RMSE/MAE
print("\n6. Оценка точности предсказаний...")
evaluator = Evaluator(metrics=['rmse', 'mae', 'mse'])
results = evaluator.evaluate(model, test, task='rating_prediction')

print("\n   Результаты:")
evaluator.print_results(results)

# 7. Рекомендации (top-rated items)
print("\n7. Рекомендации с высокими предсказанными рейтингами...")
recommendations = model.recommend([1, 2], k=5, exclude_seen=True)

for user_id, items in recommendations.items():
    print(f"\n   User {user_id}:")
    for item_id, score in items:
        print(f"      Item {item_id}: estimated rating = {score:.2f}")

print("\n" + "=" * 60)
print("✅ ПРИМЕР 2 ЗАВЕРШЁН")
print("=" * 60)
```

## Пример 3: Sequential рекомендации (SASRec)

Предсказание следующего действия пользователя.

```python
# ==================== ПОЛНЫЙ ПРИМЕР ====================
from recommender import (
    SASRecRecommender,
    load_movielens,
    InteractionDataset,
    Evaluator
)

print("=" * 60)
print("ПРИМЕР 3: Sequential рекомендации с SASRec")
print("=" * 60)

# 1. Загрузка (с timestamp!)
print("\n1. Загрузка MovieLens-100K...")
df = load_movielens(size='100k')
print(f"   Timestamp от {df['timestamp'].min()} до {df['timestamp'].max()}")

# 2. Подготовка для sequential модели
print("\n2. Подготовка sequential данных...")
dataset = InteractionDataset(
    df,
    implicit=True,
    min_user_interactions=10  # Нужна история
)

# 3. Temporal split (важно!)
print("\n3. Temporal split...")
train, test = dataset.split(
    test_size=0.2,
    strategy='temporal',  # По времени!
    seed=42
)

# 4. Обучение SASRec
print("\n4. Обучение SASRec (требуется GPU)...")
model = SASRecRecommender(
    hidden_units=50,
    n_blocks=2,
    n_heads=1,
    max_seq_length=50,
    dropout_rate=0.2,
    epochs=50,
    batch_size=128,
    device='cuda'  # Или 'cpu' если нет GPU
)

model.fit(train.data)
print("   ✅ Обучение завершено!")

# 5. Предсказание следующего item
print("\n5. Предсказание следующих items...")
sample_users = [1, 2, 3]

# Показать последовательность пользователя
for user_id in sample_users:
    user_history = train.data[train.data['user_id'] == user_id].sort_values('timestamp')
    recent_items = user_history['item_id'].tail(5).tolist()
    print(f"\n   User {user_id} недавно взаимодействовал с:")
    print(f"      {recent_items}")

# Рекомендации следующих items
recommendations = model.recommend(sample_users, k=5)

for user_id in sample_users:
    items = recommendations[user_id]
    print(f"\n   Следующие items для User {user_id}:")
    for item_id, score in items:
        print(f"      Item {item_id}: score = {score:.3f}")

# 6. Оценка
print("\n6. Оценка...")
evaluator = Evaluator(
    metrics=['precision', 'recall', 'ndcg', 'hit_rate'],
    k_values=[5, 10]
)
results = evaluator.evaluate(model, test, task='ranking', train_data=train)

print("\n   Результаты:")
evaluator.print_results(results)

print("\n" + "=" * 60)
print("✅ ПРИМЕР 3 ЗАВЕРШЁН")
print("=" * 60)
```

## Пример 4: Production Pipeline (FAISS + API)

Полный production-ready pipeline.

```python
# ==================== ПОЛНЫЙ ПРИМЕР ====================
from recommender import (
    EASERecommender,
    load_movielens,
    InteractionDataset,
    Evaluator
)
from recommender.utils import FAISSIndex, create_faiss_index_from_model
import numpy as np

print("=" * 60)
print("ПРИМЕР 4: Production Pipeline")
print("=" * 60)

# 1. Подготовка и обучение модели
print("\n1. Обучение модели...")
df = load_movielens(size='1m')
dataset = InteractionDataset(df, implicit=True, min_user_interactions=5)
train, test = dataset.split(test_size=0.1, seed=42)

model = EASERecommender(l2_reg=500.0)
model.fit(train.data)
print("   ✅ Модель обучена")

# 2. Создание FAISS индекса
print("\n2. Создание FAISS индекса...")
# Для EASE нужно получить item embeddings
# (для NCF/LightGCN можно напрямую использовать item_embeddings)

# Получаем item-item similarity matrix как embeddings
item_similarity = model.item_sim_matrix  # (n_items, n_items)

# Создаём FAISS индекс
import faiss
embedding_dim = item_similarity.shape[1]
faiss_index = faiss.IndexFlatIP(embedding_dim)  # Inner Product
faiss_index.add(item_similarity.astype('float32'))

print(f"   ✅ FAISS индекс создан: {faiss_index.ntotal} items")

# 3. Быстрый inference с FAISS
print("\n3. Быстрый inference...")
import time

# Без FAISS
user_id = 1
user_idx = model.user_mapping[user_id]
user_vector = model.user_item_matrix[user_idx]  # User's interactions

start = time.time()
# Традиционный способ
scores = user_vector @ model.item_sim_matrix.T
top_k_indices = np.argsort(scores)[::-1][:10]
time_no_faiss = time.time() - start

# С FAISS
start = time.time()
user_vec_normalized = user_vector.reshape(1, -1).astype('float32')
distances, indices = faiss_index.search(user_vec_normalized, k=10)
time_with_faiss = time.time() - start

print(f"   Без FAISS: {time_no_faiss*1000:.2f}ms")
print(f"   С FAISS: {time_with_faiss*1000:.2f}ms")
print(f"   Ускорение: {time_no_faiss/time_with_faiss:.1f}x")

# 4. Сохранение для production
print("\n4. Сохранение production artifacts...")
model.save('production/model.pkl')
faiss.write_index(faiss_index, 'production/faiss_index.bin')
print("   ✅ Модель и FAISS индекс сохранены")

# 5. Создание FastAPI сервиса
print("\n5. Создание API сервиса...")

# Создать api.py файл
api_code = """
from fastapi import FastAPI
from pydantic import BaseModel
from typing import List
import uvicorn

from recommender import EASERecommender
import faiss
import numpy as np

app = FastAPI()

# Загрузка модели и индекса
model = EASERecommender()
model.load('production/model.pkl')
faiss_index = faiss.read_index('production/faiss_index.bin')

class RecommendRequest(BaseModel):
    user_ids: List[int]
    k: int = 10

@app.get("/health")
def health():
    return {"status": "healthy"}

@app.post("/recommend")
def recommend(request: RecommendRequest):
    recommendations = model.recommend(request.user_ids, k=request.k)
    return {"recommendations": recommendations}

if __name__ == "__main__":
    uvicorn.run(app, host="0.0.0.0", port=8000)
"""

with open('production/api.py', 'w') as f:
    f.write(api_code)

print("   ✅ API код сохранён в production/api.py")
print("\n   Для запуска:")
print("      cd production")
print("      python api.py")

# 6. Финальная оценка
print("\n6. Финальная оценка на test...")
evaluator = Evaluator(metrics=['ndcg'], k_values=[10])
results = evaluator.evaluate(model, test, task='ranking', train_data=train)
print(f"   NDCG@10: {results['ndcg@10']:.4f}")

print("\n" + "=" * 60)
print("✅ ПРИМЕР 4 ЗАВЕРШЁН")
print("=" * 60)
```

## Пример 5: Сравнение всех моделей

Комплексное сравнение всех доступных моделей.

```python
# ==================== ПОЛНЫЙ ПРИМЕР ====================
from recommender import *
import pandas as pd
import time

print("=" * 70)
print("ПРИМЕР 5: Сравнение всех моделей")
print("=" * 70)

# 1. Подготовка данных
print("\n1. Подготовка данных...")
df = load_movielens(size='100k')
dataset = InteractionDataset(df, implicit=True, min_user_interactions=5)
train, val, test = dataset.split(test_size=0.2, val_size=0.1, seed=42)

# 2. Определение моделей
print("\n2. Инициализация моделей...")
models = {
    'EASE': EASERecommender(l2_reg=500.0),
    'SLIM': SLIMRecommender(l1_reg=0.1, l2_reg=0.1, max_iter=100),
    'SVD': SVDRecommender(n_components=50),
    'ALS': ALSRecommender(n_factors=50, n_iterations=15),
    'NCF': NCFRecommender(embedding_dim=64, epochs=20, device='cpu')
}

# 3. Обучение и оценка
print("\n3. Обучение и оценка всех моделей...")
evaluator = Evaluator(
    metrics=['precision', 'recall', 'ndcg', 'hit_rate'],
    k_values=[10]
)

results = {}
training_times = {}

for name, model in models.items():
    print(f"\n   {'='*60}")
    print(f"   Модель: {name}")
    print(f"   {'='*60}")
    
    # Обучение
    start = time.time()
    try:
        model.fit(train.data)
        training_time = time.time() - start
        training_times[name] = training_time
        print(f"   ✅ Обучено за {training_time:.2f}s")
        
        # Оценка
        model_results = evaluator.evaluate(
            model, test,
            task='ranking',
            train_data=train
        )
        results[name] = model_results
        
        # Вывод метрик
        print(f"   Precision@10: {model_results['precision@10']:.4f}")
        print(f"   Recall@10: {model_results['recall@10']:.4f}")
        print(f"   NDCG@10: {model_results['ndcg@10']:.4f}")
        
    except Exception as e:
        print(f"   ❌ Ошибка: {e}")

# 4. Итоговое сравнение
print("\n" + "=" * 70)
print("ИТОГОВОЕ СРАВНЕНИЕ")
print("=" * 70)

comparison_df = pd.DataFrame({
    'Model': list(results.keys()),
    'Training Time (s)': [training_times[m] for m in results.keys()],
    'Precision@10': [results[m]['precision@10'] for m in results.keys()],
    'Recall@10': [results[m]['recall@10'] for m in results.keys()],
    'NDCG@10': [results[m]['ndcg@10'] for m in results.keys()],
})

# Сортировка по NDCG
comparison_df = comparison_df.sort_values('NDCG@10', ascending=False)

print("\n", comparison_df.to_string(index=False))

# 5. Лучшая модель
best_model_name = comparison_df.iloc[0]['Model']
best_ndcg = comparison_df.iloc[0]['NDCG@10']

print(f"\n✅ Лучшая модель: {best_model_name} (NDCG@10 = {best_ndcg:.4f})")

print("\n" + "=" * 70)
print("✅ ПРИМЕР 5 ЗАВЕРШЁН")
print("=" * 70)
```

## Запуск примеров

Все примеры можно запустить из командной строки:

```bash
# Пример 1
python examples/example1_implicit_ease.py

# Пример 2
python examples/example2_explicit_svdpp.py

# Пример 3 (требуется GPU)
python examples/example3_sequential_sasrec.py

# Пример 4
python examples/example4_production_pipeline.py

# Пример 5 (займёт время)
python examples/example5_comparison.py
```

## Что дальше?

- **[FAQ](11_faq.md)** - Часто задаваемые вопросы и решение проблем
- **[Введение](01_введение.md)** - Вернуться к началу документации

---

**Предыдущая глава**: [← Продакшн решения](09_продакшн.md)  
**Следующая глава**: [FAQ →](11_faq.md)


name: Sync Docs to Wiki (Advanced)

on:
  push:
    branches:
      - master
    paths:
      - 'docs/**'
      - '.github/workflows/sync-wiki-advanced.yml'
  workflow_dispatch:

jobs:
  sync-wiki:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Checkout Wiki
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}.wiki
          path: wiki
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Sync and transform docs
        run: |
          python3 << 'EOF'
          import os
          import re
          import shutil
          from pathlib import Path
          
          def transform_filename(filename):
              """
              –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤ –¥–ª—è Wiki:
              01_–≤–≤–µ–¥–µ–Ω–∏–µ.md -> –í–≤–µ–¥–µ–Ω–∏–µ.md
              02_–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞_–¥–∞–Ω–Ω—ã—Ö.md -> –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞-–¥–∞–Ω–Ω—ã—Ö.md
              README.md -> Home.md (–µ—Å–ª–∏ –≤ –∫–æ—Ä–Ω–µ docs/)
              """
              if filename == 'README.md':
                  return 'Home.md'
              
              # –£–¥–∞–ª—è–µ–º —á–∏—Å–ª–æ–≤—ã–µ –ø—Ä–µ—Ñ–∏–∫—Å—ã (01_, 02_ –∏ —Ç.–¥.)
              name = re.sub(r'^\d+[_-]', '', filename)
              
              # –ó–∞–º–µ–Ω—è–µ–º –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è –Ω–∞ –¥–µ—Ñ–∏—Å—ã (–¥–ª—è –∫—Ä–∞—Å–∏–≤—ã—Ö URL)
              name = name.replace('_', '-')
              
              # –î–µ–ª–∞–µ–º –ø–µ—Ä–≤—É—é –±—É–∫–≤—É –∑–∞–≥–ª–∞–≤–Ω–æ–π
              if name:
                  name = name[0].upper() + name[1:]
              
              return name
          
          def process_markdown(content, source_path):
              """
              –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ markdown:
              - –ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Å—ã–ª–∫–∏ –Ω–∞ –¥—Ä—É–≥–∏–µ —Ñ–∞–π–ª—ã
              - –î–æ–±–∞–≤–ª—è–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
              """
              # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å—Å—ã–ª–∫–∏
              # [—Ç–µ–∫—Å—Ç](01_–≤–≤–µ–¥–µ–Ω–∏–µ.md) -> [—Ç–µ–∫—Å—Ç](–í–≤–µ–¥–µ–Ω–∏–µ)
              def fix_link(match):
                  text = match.group(1)
                  link = match.group(2)
                  
                  if link.endswith('.md'):
                      # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞
                      new_name = transform_filename(Path(link).name)
                      new_name = new_name[:-3]  # –£–±–∏—Ä–∞–µ–º .md –¥–ª—è wiki —Å—Å—ã–ª–æ–∫
                      return f'[{text}]({new_name})'
                  return match.group(0)
              
              content = re.sub(r'\[([^\]]+)\]\(([^)]+\.md)\)', fix_link, content)
              
              return content
          
          # –û—á–∏—â–∞–µ–º wiki (–∫—Ä–æ–º–µ .git)
          wiki_path = Path('wiki')
          for item in wiki_path.iterdir():
              if item.name != '.git':
                  if item.is_dir():
                      shutil.rmtree(item)
                  else:
                      item.unlink()
          
          # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º docs/ru
          docs_path = Path('docs/ru')
          if docs_path.exists():
              for md_file in sorted(docs_path.glob('*.md')):
                  # –ß–∏—Ç–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
                  content = md_file.read_text(encoding='utf-8')
                  
                  # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
                  content = process_markdown(content, md_file)
                  
                  # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞
                  new_name = transform_filename(md_file.name)
                  
                  # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ wiki
                  output_file = wiki_path / new_name
                  output_file.write_text(content, encoding='utf-8')
                  
                  print(f'‚úì {md_file.name} -> {new_name}')
          
          # –ö–æ–ø–∏—Ä—É–µ–º README –∫–∞–∫ Home.md –µ—Å–ª–∏ –Ω–µ—Ç
          readme = Path('README.md')
          home = wiki_path / 'Home.md'
          if readme.exists() and not home.exists():
              content = readme.read_text(encoding='utf-8')
              home.write_text(content, encoding='utf-8')
              print('‚úì README.md -> Home.md')
          
          print('\n‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞')
          EOF
      
      - name: Create sidebar
        run: |
          python3 << 'EOF'
          from pathlib import Path
          import re
          
          wiki_path = Path('wiki')
          
          # –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã –∫—Ä–æ–º–µ Home.md –∏ _Sidebar.md
          md_files = []
          for f in sorted(wiki_path.glob('*.md')):
              if f.name not in ['Home.md', '_Sidebar.md']:
                  # –ò–º—è –±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
                  name = f.stem
                  # –ó–∞–º–µ–Ω—è–µ–º –¥–µ—Ñ–∏—Å—ã –Ω–∞ –ø—Ä–æ–±–µ–ª—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                  display_name = name.replace('-', ' ')
                  md_files.append((name, display_name))
          
          # –°–æ–∑–¥–∞–µ–º —Å–∞–π–¥–±–∞—Ä
          sidebar_content = "# üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è\n\n"
          sidebar_content += "## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ\n\n"
          
          for name, display in md_files:
              sidebar_content += f"- [{display}]({name})\n"
          
          sidebar_content += "\n---\n\n"
          sidebar_content += "## –°—Å—ã–ª–∫–∏\n\n"
          sidebar_content += "- [üè† –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞](Home)\n"
          sidebar_content += "- [üì¶ PyPI](https://pypi.org/project/sota-recommender/)\n"
          sidebar_content += "- [üíª GitHub](https://github.com/hichnicksemen/svd-recommender)\n"
          
          sidebar_file = wiki_path / '_Sidebar.md'
          sidebar_file.write_text(sidebar_content, encoding='utf-8')
          
          print('‚úì –°–æ–∑–¥–∞–Ω _Sidebar.md')
          EOF
      
      - name: Commit and push
        working-directory: wiki
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add .
          
          if git diff --staged --quiet; then
            echo "üìù –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏"
            exit 0
          fi
          
          git commit -m "üîÑ Auto-sync from docs/ (commit ${{ github.sha }})"
          git push
          
          echo "‚úÖ Wiki –æ–±–Ω–æ–≤–ª–µ–Ω–∞!"
      
      - name: Summary
        run: |
          echo "### ‚úÖ Wiki —É—Å–ø–µ—à–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–∞" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìö **–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å Wiki:** https://github.com/${{ github.repository }}/wiki" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          find wiki -name "*.md" -not -path "*/\.git/*" | sort | while read file; do
            echo "- \`$(basename $file)\`" >> $GITHUB_STEP_SUMMARY
          done

